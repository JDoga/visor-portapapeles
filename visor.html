<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Texto con parseo JPDB oficial y tooltip</title>
<style>
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    margin: 0; padding: 1em;
    background-color: #121212;
    color: #f1f1f1;
    line-height: 1.6;
  }

  #textContainer {
    background-color: #1e1e1e;
    padding: 1em;
    border-radius: 8px;
    font-size: var(--fontSize, 16px);
    user-select: text;
  }

  .line {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5em;
    word-break: break-word;
  }

  .text-content {
    flex-grow: 1;
  }

  .deleteBtn {
    margin-left: 0.5em;
    background-color: #ff4444;
    border: none;
    border-radius: 4px;
    color: white;
    cursor: pointer;
    padding: 0.2em 0.5em;
    flex-shrink: 0;
  }

  .deleteBtn:hover {
    background-color: #cc0000;
  }

  #charCount {
    margin-top: 1em;
    font-size: 0.9em;
    text-align: center;
    color: #ccc;
  }

  .controls {
    text-align: center;
    margin-top: 1em;
  }

  .controls button {
    margin: 0 0.3em;
    padding: 0.5em 0.8em;
    font-size: 1em;
    border: none;
    border-radius: 6px;
    background-color: #333;
    color: white;
    cursor: pointer;
  }

  .controls button:hover {
    background-color: #555;
  }

  #clearBtn {
    display: block;
    margin: 2em auto 0 auto;
    padding: 0.6em 1.2em;
    font-size: 1em;
    border: none;
    border-radius: 6px;
    background-color: #ff4444;
    color: white;
    cursor: pointer;
  }

  #clearBtn:hover {
    background-color: #cc0000;
  }

  a.jpdb-link {
    color: inherit;  /* color blanco original */
    text-decoration: none; /* sin subrayado */
    cursor: pointer;
  }

  a.jpdb-link:hover {
    text-decoration: underline; /* opcional, solo on hover */
  }

  .tooltip {
    position: absolute;
    background-color: #222;
    color: #eee;
    padding: 0.6em 1em;
    border-radius: 8px;
    font-size: 0.9em;
    max-width: 300px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.8);
    z-index: 1000;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.2s ease;
  }

  .tooltip.visible {
    opacity: 1;
    pointer-events: auto;
  }

  .tooltip .word {
    font-weight: bold;
    margin-bottom: 0.3em;
    display: block;
  }

  .tooltip .meanings {
    font-style: italic;
    margin-bottom: 0.3em;
  }
</style>
</head>
<body>

<h2>Texto acumulado:</h2>
<div id="textContainer"></div>
<div id="charCount"></div>

<div class="controls">
  <button id="increaseFont">‚ûï Aumentar</button>
  <button id="decreaseFont">‚ûñ Reducir</button>
</div>

<button id="clearBtn">üóëÔ∏è Borrar todo</button>

<div id="tooltip" class="tooltip"></div>

<script>
const STORAGE_KEY = "textoGuardado";
const FONT_KEY = "fontSize";
const params = new URLSearchParams(window.location.search);
const nuevoTexto = params.get("text") || "";
const decodificado = decodeURIComponent(nuevoTexto.replace(/\+/g, " "));

let anterior = localStorage.getItem(STORAGE_KEY) || "";
if (decodificado) {
  anterior += (anterior ? "\n" : "") + decodificado;
  localStorage.setItem(STORAGE_KEY, anterior);
}

const tooltip = document.getElementById("tooltip");

function positionTooltip(event) {
  const padding = 10;
  let x = event.pageX + padding;
  let y = event.pageY + padding;
  const tooltipRect = tooltip.getBoundingClientRect();
  const viewportWidth = window.innerWidth;
  const viewportHeight = window.innerHeight;

  if (x + tooltipRect.width > viewportWidth) {
    x = event.pageX - tooltipRect.width - padding;
  }
  if (y + tooltipRect.height > viewportHeight) {
    y = event.pageY - tooltipRect.height - padding;
  }

  tooltip.style.left = x + "px";
  tooltip.style.top = y + "px";
}

async function fetchJPDBInfo(word) {
  const url = `https://jpdb.io/api/v1/parse?sentence=${encodeURIComponent(word)}`;
  try {
    const res = await fetch(url);
    if (!res.ok) throw new Error("API JPDB error");
    const data = await res.json();
    const token = data.tokens?.find(t => t.surface_form === word);
    if (!token) return null;
    const reading = token.reading || "";
    const meanings = token.meanings?.join(", ") || "";
    return { word, reading, meanings };
  } catch {
    return null;
  }
}

function showTooltip(info, event) {
  if (!info) {
    tooltip.classList.remove("visible");
    return;
  }
  tooltip.innerHTML = `
    <span class="word">${info.word} ${info.reading ? `(${info.reading})` : ""}</span>
    <span class="meanings">${info.meanings}</span>
  `;
  positionTooltip(event);
  tooltip.classList.add("visible");
}

function hideTooltip() {
  tooltip.classList.remove("visible");
}

// Esta funci√≥n crea un enlace con tooltip para una palabra ya parseada
function crearEnlaceJPDB(word) {
  const a = document.createElement("a");
  a.href = `https://jpdb.io/search?q=${encodeURIComponent(word)}`;
  a.target = "_blank";
  a.rel = "noopener noreferrer";
  a.textContent = word;
  a.className = "jpdb-link";

  a.addEventListener("mouseenter", async (e) => {
    const info = await fetchJPDBInfo(word);
    showTooltip(info, e);
  });

  a.addEventListener("mousemove", positionTooltip);

  a.addEventListener("mouseleave", () => {
    hideTooltip();
  });

  a.addEventListener("touchstart", async (e) => {
    e.preventDefault();
    const info = await fetchJPDBInfo(word);
    if (tooltip.classList.contains("visible")) {
      hideTooltip();
    } else {
      showTooltip(info, e.touches[0]);
    }
  });

  document.addEventListener("touchstart", (e) => {
    if (!tooltip.contains(e.target) && !a.contains(e.target)) {
      hideTooltip();
    }
  });

  return a;
}

// Ahora parseamos cada l√≠nea usando la API oficial JPDB y luego generamos los enlaces
async function parseLineConJPDB(line) {
  const url = `https://jpdb.io/api/v1/parse?sentence=${encodeURIComponent(line)}`;
  try {
    const res = await fetch(url);
    if (!res.ok) throw new Error("Error en parse JPDB");
    const data = await res.json();
    if (!data.tokens) return [document.createTextNode(line)]; // fallback

    // Por cada token creamos enlace si es palabra japonesa, si no texto normal
    return data.tokens.map(token => {
      const text = token.surface_form;
      // Consideramos que cualquier token con kanji o kana es palabra japonesa
      if (/[\p{Script=Hiragana}\p{Script=Katakana}\p{Script=Han}]/u.test(text)) {
        return crearEnlaceJPDB(text);
      } else {
        return document.createTextNode(text);
      }
    });
  } catch {
    return [document.createTextNode(line)];
  }
}

async function renderTexto() {
  const contenedor = document.getElementById("textContainer");
  contenedor.innerHTML = "";

  const lineas = (localStorage.getItem(STORAGE_KEY) || "").split("\n").filter(l => l.trim() !== "");

  // Render as√≠ncrono l√≠nea por l√≠nea para usar el parser oficial
  for (let i = 0; i < lineas.length; i++) {
    const linea = lineas[i];

    const div = document.createElement("div");
    div.className = "line";

    const span = document.createElement("span");
    span.className = "text-content";

    const linkedParts = await parseLineConJPDB(linea);
    linkedParts.forEach(part => span.appendChild(part));

    const btn = document.createElement("button");
    btn.textContent = "üóëÔ∏è";
    btn.className = "deleteBtn";
    btn.onclick = () => {
      lineas.splice(i, 1);
      localStorage.setItem(STORAGE_KEY, lineas.join("\n"));
      hideTooltip();
      renderTexto();
    };

    div.appendChild(span);
    div.appendChild(btn);
    contenedor.appendChild(div);
  }

  const sinEspacios = lineas.join("\n").replace(/\s/g, "");
  document.getElementById("charCount").textContent = "üìè Total: " + sinEspacios.length + " caracteres (sin espacios)";
}

document.getElementById("clearBtn").onclick = () => {
  localStorage.removeItem(STORAGE_KEY);
  hideTooltip();
  renderTexto();
};

let fontSize = parseInt(localStorage.getItem(FONT_KEY)) || 16;
document.documentElement.style.setProperty("--fontSize", fontSize + "px");

document.getElementById("increaseFont").onclick = () => {
  fontSize += 2;
  localStorage.setItem(FONT_KEY, fontSize);
  document.documentElement.style.setProperty("--fontSize", fontSize + "px");
};

document.getElementById("decreaseFont").onclick = () => {
  fontSize = Math.max(8, fontSize - 2);
  localStorage.setItem(FONT_KEY, fontSize);
  document.documentElement.style.setProperty("--fontSize", fontSize + "px");
};

renderTexto();
</script>

</body>
</html>
