<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Visor JPDB (Kuromoji.js)</title>
  <style>
    :root { --fontSize: 16px; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      margin: 0;
      padding: 1em;
      background: #121212;
      color: #f1f1f1;
      line-height: 1.6;
    }
    h2 { text-align:center; font-size:1.2em; margin-bottom:0.8em; }
    #textContainer {
      background:#1e1e1e; padding:1em; border-radius:8px;
      font-size: var(--fontSize);
      user-select: text;
      min-height: 4em;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .line {
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:0.6em;
      margin-bottom:0.6em;
      word-break: break-word;
    }
    .text-content { flex:1; }
    .deleteBtn {
      background:#ff4444;
      color:white;
      border:none;
      border-radius:6px;
      padding:0.2em 0.6em;
      cursor:pointer;
    }
    .controls {
      text-align:center;
      margin-top:1em;
    }
    .controls button {
      margin: 0 0.3em;
      padding:0.45em 0.8em;
      border-radius:6px;
      border:none;
      background:#333;
      color:white;
      cursor:pointer;
    }
    #clearBtn {
      display:block;
      margin:1.3em auto 0;
      padding:0.6em 1.2em;
      background:#ff4444;
      color:white;
      border:none;
      border-radius:6px;
      cursor:pointer;
    }
    /* Links estilo: blanco y sin subrayado */
    a.jpdb-link {
      color: white !important;
      text-decoration: none !important;
      cursor: pointer;
    }
    a.jpdb-link:hover {
      text-decoration: underline;
    }
    #status {
      margin-top: 0.6em;
      font-size: 0.9em;
      text-align: center;
      color: #f7b500;
    }
    #charCount {
      margin-top:0.6em;
      text-align:center;
      color:#cccccc;
      font-size:0.9em;
    }
    #debug {
      margin-top:0.6em;
      font-size:0.85em;
      color:#aaa;
      white-space:pre-wrap;
    }
  </style>
</head>
<body>
  <h2>Texto acumulado:</h2>
  <div id="status">Cargando kuromoji.js y diccionarios...</div>
  <div id="textContainer"></div>
  <div id="charCount"></div>

  <div class="controls">
    <button id="increaseFont">‚ûï Aumentar</button>
    <button id="decreaseFont">‚ûñ Reducir</button>
  </div>

  <button id="clearBtn">üóëÔ∏è Borrar todo</button>

  <div id="debug" aria-hidden="true"></div>

  <!-- Cargamos kuromoji.js desde tu repo (o CDN si prefieres) -->
  <script src="kuromoji.js"></script>

  <script>
    const STORAGE_KEY = 'textoGuardado';
    const FONT_KEY = 'fontSize';

    // Lee texto codificado en URL
    const params = new URLSearchParams(window.location.search);
    const nuevoTexto = params.get('text') || '';
    const decodificado = decodeURIComponent(nuevoTexto.replace(/\+/g, ' '));

    // Recupera texto guardado localmente
    let anterior = localStorage.getItem(STORAGE_KEY) || '';
    if (decodificado) {
      anterior += (anterior ? '\n' : '') + decodificado;
      localStorage.setItem(STORAGE_KEY, anterior);
    }

    const textContainer = document.getElementById('textContainer');
    const debugEl = document.getElementById('debug');
    const statusEl = document.getElementById('status');

    // Ruta de diccionarios en GitHub Pages (ajusta si cambias)
    const dicPath = "https://jdoga.github.io/visor-portapapeles/dict/";

    let tokenizer;
    let tokenizerReady = false;

    statusEl.textContent = "Cargando kuromoji.js y diccionarios...";

    kuromoji.builder({ dicPath: dicPath }).build((err, _tokenizer) => {
      if (err) {
        statusEl.textContent = "Error al cargar kuromoji: " + err.message;
        statusEl.style.color = '#ff4444';
        console.error(err);
        return;
      }
      tokenizer = _tokenizer;
      tokenizerReady = true;
      statusEl.textContent = "Kuromoji cargado correctamente.";
      statusEl.style.color = '#8be18b';

      renderTexto();
    });

    function hasJapaneseChars(s) {
      return /[‰∏Ä-ÈæØ„ÅÅ-„Çì„Ç°-„É≥]/.test(s);
    }

    // Tokeniza l√≠nea con kuromoji
    function segmentLine(line) {
      if (!tokenizerReady) return [line];
      try {
        const tokens = tokenizer.tokenize(line);
        return tokens.map(t => t.surface_form);
      } catch (e) {
        console.warn('Error tokenizando:', e);
        return [line];
      }
    }

    async function renderTexto() {
      textContainer.innerHTML = '';
      debugEl.textContent = '';
      const stored = (localStorage.getItem(STORAGE_KEY) || '').split('\n').filter(Boolean);

      for (let i = 0; i < stored.length; i++) {
        const linea = stored[i];
        const div = document.createElement('div');
        div.className = 'line';

        const span = document.createElement('div');
        span.className = 'text-content';

        const tokens = segmentLine(linea);

        // Mostrar tokens en debug
        debugEl.textContent += `L√≠nea ${i + 1}: ${linea}\nTokens: ${JSON.stringify(tokens)}\n\n`;

        tokens.forEach(tkn => {
          if (hasJapaneseChars(tkn)) {
            const link = document.createElement('a');
            link.className = 'jpdb-link';
            link.href = `https://jpdb.io/search?q=${encodeURIComponent(tkn)}`;
            link.target = '_blank';
            link.rel = 'noopener noreferrer';
            link.textContent = tkn;
            span.appendChild(link);
          } else {
            span.appendChild(document.createTextNode(tkn));
          }
          // Espacio visual si no es signo de puntuaci√≥n japon√©s
          if (!/^[„ÄÅ„ÄÇÔºüÔºÅ,.?ÔºÅ]$/.test(tkn)) span.appendChild(document.createTextNode(' '));
        });

        const btn = document.createElement('button');
        btn.className = 'deleteBtn';
        btn.textContent = 'üóëÔ∏è';
        btn.onclick = () => {
          stored.splice(i, 1);
          localStorage.setItem(STORAGE_KEY, stored.join('\n'));
          renderTexto();
        };

        div.appendChild(span);
        div.appendChild(btn);
        textContainer.appendChild(div);
      }

      const sinEspacios = stored.join('\n').replace(/\s/g, '');
      document.getElementById('charCount').textContent = `üìè Total: ${sinEspacios.length} caracteres (sin espacios)`;
    }

    // Control tama√±o fuente
    let fontSize = parseInt(localStorage.getItem(FONT_KEY)) || 16;
    document.documentElement.style.setProperty('--fontSize', fontSize + 'px');

    document.getElementById('increaseFont').onclick = () => {
      fontSize += 2;
      localStorage.setItem(FONT_KEY, fontSize);
      document.documentElement.style.setProperty('--fontSize', fontSize + 'px');
    };

    document.getElementById('decreaseFont').onclick = () => {
      fontSize = Math.max(8, fontSize - 2);
      localStorage.setItem(FONT_KEY, fontSize);
      document.documentElement.style.setProperty('--fontSize', fontSize + 'px');
    };

    document.getElementById('clearBtn').onclick = () => {
      localStorage.removeItem(STORAGE_KEY);
      renderTexto();
    };
  </script>
</body>
</html>
