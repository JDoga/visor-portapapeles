<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Visor JPDB + Backend</title>
<style>
  body { font-family: sans-serif; background:#121212; color:#eee; padding:1em; }
  a { color:#7ecbff; text-decoration: underline; cursor: pointer; }
</style>
</head>
<body>
  <h1>Texto parseado con backend JPDB</h1>
  <div id="textContainer"></div>

<script>
const STORAGE_KEY = "textoGuardado";
const API_URL = 'https://jpdb-backend-production.up.railway.app/parse'; // URL backend pÃºblica
const params = new URLSearchParams(window.location.search);
const nuevoTexto = params.get("text") || "";
const decodificado = decodeURIComponent(nuevoTexto.replace(/\+/g, " "));

let anterior = localStorage.getItem(STORAGE_KEY) || "";
if (decodificado) {
  anterior += (anterior ? "\n" : "") + decodificado;
  localStorage.setItem(STORAGE_KEY, anterior);
}

async function parseWithBackend(sentence) {
  try {
    const res = await fetch(API_URL, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ sentence })
    });
    if (!res.ok) throw new Error('API error');
    return await res.json();
  } catch {
    return null;
  }
}

function crearEnlaceJPDB(word) {
  const a = document.createElement("a");
  a.href = `https://jpdb.io/search?q=${encodeURIComponent(word)}`;
  a.target = "_blank";
  a.rel = "noopener noreferrer";
  a.textContent = word;
  return a;
}

async function renderTexto() {
  const contenedor = document.getElementById("textContainer");
  contenedor.innerHTML = "";

  const lineas = (localStorage.getItem(STORAGE_KEY) || "").split("\n").filter(l => l.trim() !== "");

  for (const linea of lineas) {
    const div = document.createElement("div");

    const data = await parseWithBackend(linea);
    if (!data || !data.tokens) {
      div.textContent = linea; // fallback si falla parseo
    } else {
      data.tokens.forEach(token => {
        div.appendChild(crearEnlaceJPDB(token.surface_form));
        div.appendChild(document.createTextNode(" "));
      });
    }
    contenedor.appendChild(div);
  }
}

renderTexto();
</script>
</body>
</html>
