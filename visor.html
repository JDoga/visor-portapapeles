<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Texto acumulado con b√∫squeda JPDB</title>
<style>
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    margin: 0;
    padding: 1em;
    background-color: #121212;
    color: #f1f1f1;
    line-height: 1.6;
    user-select: text; /* Permitir selecci√≥n */
  }

  h2 {
    font-size: 1.3em;
    text-align: center;
    margin-bottom: 1em;
  }

  #textContainer {
    background-color: #1e1e1e;
    padding: 1em;
    border-radius: 8px;
    font-size: var(--fontSize, 16px);
  }

  .line {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5em;
  }

  .line span {
    flex-grow: 1;
    word-wrap: break-word;
    overflow-wrap: break-word;
  }

  .deleteBtn {
    margin-left: 0.5em;
    background-color: #ff4444;
    border: none;
    border-radius: 4px;
    color: white;
    cursor: pointer;
    padding: 0.2em 0.5em;
  }

  .deleteBtn:hover {
    background-color: #cc0000;
  }

  #charCount {
    margin-top: 1em;
    font-size: 0.9em;
    text-align: center;
    color: #cccccc;
  }

  .controls {
    text-align: center;
    margin-top: 1em;
  }

  .controls button {
    margin: 0 0.3em;
    padding: 0.5em 0.8em;
    font-size: 1em;
    border: none;
    border-radius: 6px;
    background-color: #333;
    color: white;
    cursor: pointer;
  }

  .controls button:hover {
    background-color: #555;
  }

  #clearBtn {
    display: block;
    margin: 2em auto 0 auto;
    padding: 0.6em 1.2em;
    font-size: 1em;
    border: none;
    border-radius: 6px;
    background-color: #ff4444;
    color: white;
    cursor: pointer;
  }

  #clearBtn:hover {
    background-color: #cc0000;
  }

  /* Bot√≥n de b√∫squeda flotante */
  #searchBtn {
    position: fixed;
    background-color: #007aff;
    color: white;
    border: none;
    border-radius: 20px;
    padding: 8px 15px;
    font-size: 16px;
    cursor: pointer;
    user-select: none; /* evitar selecci√≥n del bot√≥n */
    box-shadow: 0 2px 8px rgba(0,0,0,0.4);
    display: none;
    z-index: 1000;
  }
</style>
</head>
<body>

<h2>Texto acumulado:</h2>
<div id="textContainer"></div>
<div id="charCount"></div>

<div class="controls">
  <button id="increaseFont">‚ûï Aumentar</button>
  <button id="decreaseFont">‚ûñ Reducir</button>
</div>

<button id="clearBtn">üóëÔ∏è Borrar todo</button>

<!-- Bot√≥n b√∫squeda -->
<button id="searchBtn" aria-label="Buscar selecci√≥n en JPDB">üîç Buscar en JPDB</button>

<script>
  const STORAGE_KEY = "textoGuardado";
  const FONT_KEY = "fontSize";
  const params = new URLSearchParams(window.location.search);
  const nuevoTexto = params.get("text") || "";
  const decodificado = decodeURIComponent(nuevoTexto.replace(/\+/g, " "));

  let anterior = localStorage.getItem(STORAGE_KEY) || "";
  if (decodificado) {
    anterior += (anterior ? "\n" : "") + decodificado;
    localStorage.setItem(STORAGE_KEY, anterior);
  }

  function renderTexto() {
    const contenedor = document.getElementById("textContainer");
    contenedor.innerHTML = "";

    const lineas = (localStorage.getItem(STORAGE_KEY) || "").split("\n").filter(l => l.trim() !== "");
    lineas.forEach((linea, index) => {
      const div = document.createElement("div");
      div.className = "line";

      const span = document.createElement("span");
      span.textContent = linea;

      const btn = document.createElement("button");
      btn.textContent = "üóëÔ∏è";
      btn.className = "deleteBtn";
      btn.onclick = () => {
        lineas.splice(index, 1);
        localStorage.setItem(STORAGE_KEY, lineas.join("\n"));
        renderTexto();
      };

      div.appendChild(span);
      div.appendChild(btn);
      contenedor.appendChild(div);
    });

    const sinEspacios = lineas.join("\n").replace(/\s/g, "");
    document.getElementById("charCount").textContent = "üìè Total: " + sinEspacios.length + " caracteres (sin espacios)";
  }

  document.getElementById("clearBtn").onclick = () => {
    localStorage.removeItem(STORAGE_KEY);
    renderTexto();
  };

  // Fuente
  let fontSize = parseInt(localStorage.getItem(FONT_KEY)) || 16;
  document.documentElement.style.setProperty("--fontSize", fontSize + "px");

  document.getElementById("increaseFont").onclick = () => {
    fontSize += 2;
    localStorage.setItem(FONT_KEY, fontSize);
    document.documentElement.style.setProperty("--fontSize", fontSize + "px");
  };

  document.getElementById("decreaseFont").onclick = () => {
    fontSize = Math.max(8, fontSize - 2);
    localStorage.setItem(FONT_KEY, fontSize);
    document.documentElement.style.setProperty("--fontSize", fontSize + "px");
  };

  renderTexto();

  // --- SELECCI√ìN Y BOT√ìN DE B√öSQUEDA ---

  const searchBtn = document.getElementById("searchBtn");

  // Para posicionar el bot√≥n cerca de la selecci√≥n
  function positionButton() {
    const selection = window.getSelection();
    if (!selection.rangeCount) return;

    const range = selection.getRangeAt(0);
    const rect = range.getBoundingClientRect();

    // Si no hay √°rea visible, ocultar bot√≥n
    if (rect.width === 0 || rect.height === 0) {
      searchBtn.style.display = "none";
      return;
    }

    // Ajustar posici√≥n: un poco m√°s abajo para evitar dedo o teclado
    let top = rect.bottom + window.scrollY + 10; 
    let left = rect.left + window.scrollX + rect.width / 2;

    // Limitar que no se salga de la pantalla
    if (left + searchBtn.offsetWidth / 2 > window.innerWidth) {
      left = window.innerWidth - searchBtn.offsetWidth - 10;
    } else if (left - searchBtn.offsetWidth / 2 < 0) {
      left = 10;
    }

    searchBtn.style.top = `${top}px`;
    searchBtn.style.left = `${left - searchBtn.offsetWidth / 2}px`;
    searchBtn.style.display = "block";
  }

  // Control selecci√≥n
  document.addEventListener("selectionchange", () => {
    const selection = window.getSelection();
    const texto = selection.toString().trim();

    // Mostrar bot√≥n solo si selecci√≥n > 1 y menos de 30 caracteres (para evitar selecci√≥n gigante)
    if (texto.length > 0 && texto.length <= 30) {
      positionButton();
    } else {
      searchBtn.style.display = "none";
    }
  });

  // Al pulsar el bot√≥n, abrir jpdb y limpiar selecci√≥n para evitar men√∫ iOS
  searchBtn.addEventListener("click", () => {
    const selection = window.getSelection();
    const texto = selection.toString().trim();

    if (texto.length === 0) {
      searchBtn.style.display = "none";
      return;
    }

    // Abrir jpdb en nueva pesta√±a, buscar texto seleccionado codificado en URL
    const url = `https://jpdb.io/search?keyword=${encodeURIComponent(texto)}`;
    window.open(url, "_blank");

    // Quitar selecci√≥n para que desaparezca men√∫ iOS nativo
    selection.removeAllRanges();
    searchBtn.style.display = "none";
  });

</script>

</body>
</html>
