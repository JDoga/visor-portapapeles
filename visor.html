<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Visor JPDB (kuromoji.js)</title>
  <style>
    :root { --fontSize: 16px; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      margin: 0;
      padding: 1em;
      background: #121212;
      color: #f1f1f1;
      line-height: 1.6;
    }
    h2 { text-align:center; font-size:1.2em; margin-bottom:0.8em; }
    #textContainer {
      background:#1e1e1e; padding:1em; border-radius:8px;
      font-size: var(--fontSize);
      user-select: text;
    }
    .line { display:flex; align-items:flex-start; justify-content:space-between; gap:0.6em; margin-bottom:0.6em; word-break:break-word; }
    .text-content { flex:1; }
    .deleteBtn { background:#ff4444; color:white; border:none; border-radius:6px; padding:0.2em 0.6em; cursor:pointer; }
    .controls { text-align:center; margin-top:1em; }
    .controls button { margin: 0 0.3em; padding:0.45em 0.8em; border-radius:6px; border:none; background:#333; color:white; cursor:pointer; }
    #clearBtn { display:block; margin:1.3em auto 0; padding:0.6em 1.2em; background:#ff4444; color:white; border:none; border-radius:6px; cursor:pointer; }
    a.jpdb-link { color: white !important; text-decoration: none !important; cursor: pointer; }
    a.jpdb-link:hover { text-decoration: underline; }
    #debug { margin-top:0.6em; font-size:0.85em; color:#aaa; white-space:pre-wrap; max-height: 150px; overflow-y: auto; }
    #charCount { margin-top:0.6em; text-align:center; color:#cccccc; font-size:0.9em; }
    #kuromojiStatus { color:#8be18b; font-size:0.9em; margin-bottom:0.6em; text-align:center; }
  </style>
</head>
<body>
  <h2>Texto acumulado:</h2>
  <div id="kuromojiStatus">Cargando kuromoji.js...</div>
  <div id="textContainer"></div>
  <div id="charCount"></div>

  <div class="controls">
    <button id="increaseFont">‚ûï Aumentar</button>
    <button id="decreaseFont">‚ûñ Reducir</button>
  </div>

  <button id="clearBtn">üóëÔ∏è Borrar todo</button>

  <div id="debug" aria-hidden="true"></div>

  <!-- Cargamos kuromoji desde CDN -->
  <script src="https://cdn.jsdelivr.net/npm/kuromoji@0.1.2/dist/kuromoji.js"></script>

  <script>
  const STORAGE_KEY = 'textoGuardado';
  const FONT_KEY = 'fontSize';

  const params = new URLSearchParams(window.location.search);
  const nuevoTexto = params.get('text') || '';
  const decodificado = decodeURIComponent(nuevoTexto.replace(/\+/g, ' '));
  let anterior = localStorage.getItem(STORAGE_KEY) || '';
  if (decodificado) {
    anterior += (anterior ? '\n' : '') + decodificado;
    localStorage.setItem(STORAGE_KEY, anterior);
  }

  const textContainer = document.getElementById('textContainer');
  const debugEl = document.getElementById('debug');
  const kuromojiStatus = document.getElementById('kuromojiStatus');

  // Helper para detectar japon√©s
  function hasJapaneseChars(s) {
    return /[‰∏Ä-ÈæØ„ÅÅ-„Çì„Ç°-„É≥]/.test(s);
  }

  // Crear enlace JPDB
  function crearEnlaceJPDB(word) {
    const a = document.createElement('a');
    a.className = 'jpdb-link';
    a.href = `https://jpdb.io/search?q=${encodeURIComponent(word)}`;
    a.target = '_blank';
    a.rel = 'noopener noreferrer';
    a.textContent = word;
    return a;
  }

  let tokenizer = null;

  // Construimos el tokenizer con diccionario local (carpeta dict)
  kuromoji.builder({ dicPath: './dict/' }).build(function (err, _tokenizer) {
    if (err) {
      kuromojiStatus.textContent = 'Error cargando kuromoji.js: ' + err;
      kuromojiStatus.style.color = '#ff4444';
      console.error(err);
      return;
    }
    tokenizer = _tokenizer;
    kuromojiStatus.textContent = 'kuromoji.js cargado correctamente.';
    kuromojiStatus.style.color = '#8be18b';
    renderTexto();
  });

  // Segmenta una l√≠nea con kuromoji (devuelve array de tokens)
  function segmentLine(line) {
    if (!tokenizer) return [line]; // si no est√° listo, devuelve la l√≠nea entera
    return tokenizer.tokenize(line).map(t => t.surface_form);
  }

  async function renderTexto() {
    textContainer.innerHTML = '';
    debugEl.textContent = '';
    const stored = (localStorage.getItem(STORAGE_KEY) || '').split('\n').filter(Boolean);
    for (let i=0;i<stored.length;i++){
      const linea = stored[i];
      const div = document.createElement('div');
      div.className = 'line';

      const span = document.createElement('div');
      span.className = 'text-content';

      const tokens = segmentLine(linea);

      debugEl.textContent += `L√≠nea ${i+1}: ${linea}\nTokens kuromoji: ${JSON.stringify(tokens)}\n\n`;

      tokens.forEach((tkn) => {
        if (hasJapaneseChars(tkn)) {
          const link = crearEnlaceJPDB(tkn);
          span.appendChild(link);
        } else {
          span.appendChild(document.createTextNode(tkn));
        }
        // espacio visual salvo puntuaci√≥n japonesa
        if (!/^[„ÄÅ„ÄÇÔºüÔºÅ,.?ÔºÅ]$/.test(tkn)) span.appendChild(document.createTextNode(' '));
      });

      const btn = document.createElement('button');
      btn.className = 'deleteBtn';
      btn.textContent = 'üóëÔ∏è';
      btn.onclick = () => {
        stored.splice(i,1);
        localStorage.setItem(STORAGE_KEY, stored.join('\n'));
        renderTexto();
      };

      div.appendChild(span);
      div.appendChild(btn);
      textContainer.appendChild(div);
    }

    const sinEspacios = stored.join('\n').replace(/\s/g,'');
    document.getElementById('charCount').textContent = `üìè Total: ${sinEspacios.length} caracteres (sin espacios)`;
  }

  // botones y control de fuente
  let fontSize = parseInt(localStorage.getItem(FONT_KEY)) || 16;
  document.documentElement.style.setProperty('--fontSize', fontSize + 'px');

  document.getElementById('increaseFont').onclick = () => {
    fontSize += 2;
    localStorage.setItem(FONT_KEY, fontSize);
    document.documentElement.style.setProperty('--fontSize', fontSize + 'px');
  };

  document.getElementById('decreaseFont').onclick = () => {
    fontSize = Math.max(8, fontSize - 2);
    localStorage.setItem(FONT_KEY, fontSize);
    document.documentElement.style.setProperty('--fontSize', fontSize + 'px');
  };

  document.getElementById('clearBtn').onclick = () => {
    localStorage.removeItem(STORAGE_KEY);
    renderTexto();
  };

  // Nota: ya no necesitamos evento load extra porque el render se llama dentro de kuromoji builder
  </script>
</body>
</html>
