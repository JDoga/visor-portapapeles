<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>JPDB M√≥vil Compatible</title>
<style>
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    margin: 0; padding: 1em;
    background-color: #121212;
    color: #f1f1f1;
    line-height: 1.6;
  }

  #textContainer {
    background-color: #1e1e1e;
    padding: 1em;
    border-radius: 8px;
    font-size: var(--fontSize, 16px);
    user-select: text;
    word-break: break-word;
  }

  .line {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5em;
  }

  .text-content {
    flex-grow: 1;
  }

  .deleteBtn {
    margin-left: 0.5em;
    background-color: #ff4444;
    border: none;
    border-radius: 4px;
    color: white;
    cursor: pointer;
    padding: 0.2em 0.5em;
    flex-shrink: 0;
  }

  .deleteBtn:hover {
    background-color: #cc0000;
  }

  #charCount {
    margin-top: 1em;
    font-size: 0.9em;
    text-align: center;
    color: #ccc;
  }

  .controls {
    text-align: center;
    margin-top: 1em;
  }

  .controls button {
    margin: 0 0.3em;
    padding: 0.5em 0.8em;
    font-size: 1em;
    border: none;
    border-radius: 6px;
    background-color: #333;
    color: white;
    cursor: pointer;
  }

  .controls button:hover {
    background-color: #555;
  }

  #clearBtn {
    display: block;
    margin: 2em auto 0 auto;
    padding: 0.6em 1.2em;
    font-size: 1em;
    border: none;
    border-radius: 6px;
    background-color: #ff4444;
    color: white;
    cursor: pointer;
  }

  #clearBtn:hover {
    background-color: #cc0000;
  }

  /* Estilo para enlaces JPDB visibles en m√≥vil */
  a.jpdb-link {
    color: #2196f3;  /* azul visible */
    text-decoration: underline; /* subrayado */
    cursor: pointer;
  }
</style>
</head>
<body>

<h2>Texto acumulado:</h2>
<div id="textContainer"></div>
<div id="charCount"></div>

<div class="controls">
  <button id="increaseFont">‚ûï Aumentar</button>
  <button id="decreaseFont">‚ûñ Reducir</button>
</div>

<button id="clearBtn">üóëÔ∏è Borrar todo</button>

<script>
const STORAGE_KEY = "textoGuardado";
const FONT_KEY = "fontSize";
const params = new URLSearchParams(window.location.search);
const nuevoTexto = params.get("text") || "";
const decodificado = decodeURIComponent(nuevoTexto.replace(/\+/g, " "));

let anterior = localStorage.getItem(STORAGE_KEY) || "";
if (decodificado) {
  anterior += (anterior ? "\n" : "") + decodificado;
  localStorage.setItem(STORAGE_KEY, anterior);
}

function crearEnlaceJPDB(word) {
  const a = document.createElement("a");
  a.href = `https://jpdb.io/search?q=${encodeURIComponent(word)}`;
  a.target = "_blank";
  a.rel = "noopener noreferrer";
  a.textContent = word;
  a.className = "jpdb-link";
  return a;
}

function simpleParseJapaneseWords(text) {
  // Regex para grupos de caracteres japoneses (kanji, hiragana, katakana)
  const regex = /([\p{Script=Han}\p{Script=Hiragana}\p{Script=Katakana}]+)/gu;
  let lastIndex = 0;
  const nodes = [];

  for (const match of text.matchAll(regex)) {
    const index = match.index;

    if (index > lastIndex) {
      // Texto antes no japon√©s
      nodes.push(document.createTextNode(text.slice(lastIndex, index)));
    }
    // Palabra japonesa
    nodes.push(crearEnlaceJPDB(match[0]));
    lastIndex = index + match[0].length;
  }

  // Texto final no japon√©s
  if (lastIndex < text.length) {
    nodes.push(document.createTextNode(text.slice(lastIndex)));
  }

  return nodes;
}

async function parseLineConJPDB(line) {
  const url = `https://jpdb.io/api/v1/parse?sentence=${encodeURIComponent(line)}`;
  try {
    console.log("Intentando parsear con API JPDB:", line);
    const res = await fetch(url);
    if (!res.ok) throw new Error(`HTTP status ${res.status}`);
    const data = await res.json();
    if (!data.tokens) throw new Error("No tokens en respuesta");

    // Construimos nodos con tokens parseados
    return data.tokens.map(token => {
      const text = token.surface_form;
      if (/[\p{Script=Hiragana}\p{Script=Katakana}\p{Script=Han}]/u.test(text)) {
        return crearEnlaceJPDB(text);
      } else {
        return document.createTextNode(text);
      }
    });
  } catch (e) {
    console.warn("Fallo parse JPDB, usando parse simple:", e);
    return simpleParseJapaneseWords(line);
  }
}

async function renderTexto() {
  const contenedor = document.getElementById("textContainer");
  contenedor.innerHTML = "";

  const lineas = (localStorage.getItem(STORAGE_KEY) || "").split("\n").filter(l => l.trim() !== "");

  for (let i = 0; i < lineas.length; i++) {
    const linea = lineas[i];

    const div = document.createElement("div");
    div.className = "line";

    const span = document.createElement("span");
    span.className = "text-content";

    const linkedParts = await parseLineConJPDB(linea);
    linkedParts.forEach(part => span.appendChild(part));

    const btn = document.createElement("button");
    btn.textContent = "üóëÔ∏è";
    btn.className = "deleteBtn";
    btn.onclick = () => {
      lineas.splice(i, 1);
      localStorage.setItem(STORAGE_KEY, lineas.join("\n"));
      renderTexto();
    };

    div.appendChild(span);
    div.appendChild(btn);
    contenedor.appendChild(div);
  }

  const sinEspacios = lineas.join("\n").replace(/\s/g, "");
  document.getElementById("charCount").textContent = "üìè Total: " + sinEspacios.length + " caracteres (sin espacios)";
}

document.getElementById("clearBtn").onclick = () => {
  localStorage.removeItem(STORAGE_KEY);
  renderTexto();
};

let fontSize = parseInt(localStorage.getItem(FONT_KEY)) || 16;
document.documentElement.style.setProperty("--fontSize", fontSize + "px");

document.getElementById("increaseFont").onclick = () => {
  fontSize += 2;
  localStorage.setItem(FONT_KEY, fontSize);
  document.documentElement.style.setProperty("--fontSize", fontSize + "px");
};

document.getElementById("decreaseFont").onclick = () => {
  fontSize = Math.max(8, fontSize - 2);
  localStorage.setItem(FONT_KEY, fontSize);
  document.documentElement.style.setProperty("--fontSize", fontSize + "px");
};

// Ejecutamos render texto asegurando el await
(async () => {
  await renderTexto();
})();
</script>

</body>
</html>
